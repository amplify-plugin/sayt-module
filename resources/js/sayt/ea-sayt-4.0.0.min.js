/*
 Copyright (c) 2000-2018 EasyAsk Technologies, Inc.  All Rights Reserved.
 Use, reproduction, transfer, publication or disclosure is prohibited
 except in accordance with the License Agreement.
*/
(function(g){"function"===typeof define&&define.amd?define("ea-sayt",["jquery","handlebars","ea-search-history","hb-helpers"],g):g(window.$ea||window.eaj$183||jQuery,null,window.EASearchHistory||null,null)})(function(g,m,h,n){var k=function(a,b){this.pluginId="ea_sayt";this.selector=a;this.$element=g(a);this.$input=this.$element.find("input");this.options=b};k.prototype={defaults:{sort:"weight",reduce:"cluster",matchAllSearchWords:!0,matchAnySuggestionWord:!0,currentSite:"",template:"/EasyAsk/sayt/templates/default.hbs",
userSuggestions:{size:8},submitFn:function(){},navClass:"ea-sug-nav-link",dataPath:"eapath",suggestionClass:"ea-search-suggestion",sectionAreaClass:"ea-sug-area",delay:200,minLength:3,server:"",url:"/EasyAsk/AutoComplete-3.0.0.jsp",defaultSearchParams:"indexed=1&ie=UTF-8&disp=json&RequestAction=advisor&RequestData=CA_Search&CatPath=All Products&defarrangeby=////NONE////",serverSearch:"",urlSearch:"/EasyAsk/apps/Advisor.jsp",search:{size:8},products:{size:3,value:function(a,b){return a[b]},fields:{id:"Product_Id",
thumbnail:"picture",name:"Product_Name",description:"Description",price:"Price",mfr:"Manufacturer"}},navigation:{size:2,sections:[{type:"category",size:5,title:"Category"},{type:"COLOR",size:4,title:"Color"},{type:"SIZE",size:3,title:"Size"}]},pageInfo:"EA_PAGE_INFO"},ENTER:13,ARROW_DOWN:40,ARROW_UP:38,init:function(){var a=this;this.$input.attr({spellcheck:"false",autocomplete:"off"});a.config=g.extend(!0,{},a.defaults,a.options);a.config.defaultSearchParams=a.config.sessionid?a.config.defaultSearchParams+
("&sessionid="+a.config.sessionid):a.config.defaultSearchParams+"&oneshot=1";a.build();a.loadAndCompile().done(function(b){a.initEvents()});this.$txtNode=g('<span style="display:none;"></span>');var b=window[a.config.pageInfo]||{};b.userSearch&&a.addUserSuggestion(b.userSearch);return a},close:function(a){this.$suggestionContainer.hide();a&&this.$input.val("")},reposition:function(){var a=this.$element.outerWidth(),b=this.$suggestionContainer.children().first().outerWidth(),c=0, d=(typeof(this.config.relativeToInput) !== "undefined" && this.config.relativeToInput) ? ((typeof($('#question')[0]) !== "undefined") ? $('#question')[0].offsetLeft : 0) : a-b-1; "right"==this.config.horizAlign?
c=d:"center"==this.config.horizAlign&&(c=(a-b-1)/2);c+=this.config.xOffset||0;this.$suggestionContainer.css("left",c+"px")},build:function(){var a=this.$element.outerHeight()+(this.config.yOffset||0);this.$suggestionContainer=g('<div class="ea-autocomplete-wrapper" style="left:0px;top:'+a+'px;"><div>');this.$element.append(this.$suggestionContainer)},loadAndCompile:function(){var a=this,b=g.Deferred();require(["text!"+a.config.template],function(c){a.compiled=m.compile(c);b.resolve()});return b.promise()},
initEvents:function(){var a=this;a.$input.off("keydown").on("keydown",function(b){a.handleKeyDown(b)});a.$input.blur(function(b){a.cancelBlur?delete a.cancelBlur:a.$suggestionContainer.hide()}).focus(function(b){a.processInput()});if(!a.config.sectionAreaClass)a.$suggestionContainer.on("mousedown",function(b){a.cancelBlur=!0;a.$suggestionContainer.delay(function(){delete a.cancelBlur})})},arrowKey:function(a){var b=this.$suggestionContainer.find(".ea-search-suggestion");if(b.length){for(var c=null,
d=-1,e=0;e<b.length;e++)if(g(b[e]).hasClass("ea-selected")){d=e;g(b[e]).removeClass("ea-selected");break}e=this.getCurrentSuggests();a.keyCode==this.ARROW_UP?-1==d?d=b.length-1:(d--,0>d&&(c=e.input)):a.keyCode==this.ARROW_DOWN&&(-1==d?d=0:(d++,d>=b.length&&(c=e.input)));c?this.$input.val(c):(c=e.suggests[d].sug,this.$input.val(c),this.getResults(d))}a.preventDefault();return!1},findAttribute:function(a,b){var c=a.source.attributes&&a.source.attributes.attribute||[];if(c.length)for(var d=0;d<c.length;d++)if(c[d].name==
b)return 1==c[d].attributeValueList[0].valueType?c[d]:null;return null},createFacet:function(a,b,c){if("category"==a.type.toLowerCase()){var d=b.source.categories&&b.source.categories.categoryList||[];if(d.length){b={title:a.title,count:d.length,vals:[]};for(c=0;c<d.length&&c<a.size;c++)b.vals.push({name:d[c].name,productCount:d[c].productCount,path:d[c].seoPath});return b}}else if(b=this.findAttribute(b,a.type)){d=b.attributeValueList;b={title:a.title,count:d.length,vals:[]};for(c=0;c<d.length&&
c<a.size;c++)b.vals.push({name:d[c].attributeValue,productCount:d[c].productCount,path:d[c].seoPath});return b}return null},createFacets:function(a,b){var c=[];if(a.source&&a.source.products&&a.source.products.items){var d=this.config.navigation;if(d&&(a.source.categories||a.source.attributes))for(var e=d.size,f=0;f<d.sections.length&&c.length<e;f++){var g=this.createFacet(d.sections[f],a,b);g&&c.push(g)}}return c},textOnly:function(a){if(a)try{return this.$txtNode.html(a).text()}catch(b){}return a},
trimString:function(a,b){if(a&&b&&!(a.length<b)){var c=a.substring(0,b),d=c.lastIndexOf(" ");-1<d&&(c=c.substring(0,d));return c+"..."}return a},createCanonicalItem:function(a){var b=this.config.products.fields,c=this.config.products.sizes,d=this.config.products.value,e={},f;for(f in b)b.hasOwnProperty(f)&&(e[f]=c[f]?this.trimString(this.textOnly(d(a,b[f])),c[f]):d(a,b[f]));return e},hookSuggestions:function(){var a=this;a.$suggestionContainer.find("."+a.config.suggestionClass).each(function(b,c){g(c).click(function(b){a.$suggestionContainer.hide();
var e=g(c).text().trim();a.$input.val(e);a.config.submitFctn("search",e,c);b.preventDefault();return!1})})},getResults:function(a){var b=this,c=b.getCurrentSuggests(),d=g.Deferred(),e=c.suggests[a].sug;g.when(b.search(e).done(function(f){var l=b.createFacets(f,e),l={offset:a,sug:c,prod:f,facets:l,fields:b.config.products.fields};if(f&&f.source&&f.source.products&&f.source.products.items){for(var h=[],k=0;k<f.source.products.items.length;k++)h.push(b.createCanonicalItem(f.source.products.items[k]));
l.canonicalItems=h}f=b.compiled(l);b.$suggestionContainer.html(f).show();if(b.config.sectionAreaClass)b.$suggestionContainer.find("."+b.config.sectionAreaClass).on("mousedown",function(a){b.cancelBlur=!0;b.$suggestionContainer.delay(function(){delete b.cancelBlur})});b.reposition();b.$suggestionContainer.find("."+b.config.navClass).each(function(a,c){g(c).click(function(a){b.$suggestionContainer.hide();b.config.submitFctn("nav",g(c).data(b.config.dataPath),c);a.preventDefault();return!1})});b.hookSuggestions();
d.resolve()}));return d.promise()},setCurrentSuggests:function(a){this.currentSuggests=a},getCurrentSuggests:function(){return this.currentSuggests},processInput:function(){var a=this,b=a.$input.val();if(b&&b.length>=a.config.minLength)g.when(a.suggest(b)).done(function(b){a.setCurrentSuggests(b);b.suggests&&b.suggests.length?a.getResults(0):a.$suggestionContainer.hide()});else if(a.config.userSuggestions)if((b=a.getUserSuggestions(b,a.config.userSuggestions.size||5))&&b.length){var b={offset:-1,
suggests:b},c=a.compiled({sug:b});a.setCurrentSuggests(b);a.$suggestionContainer.html(c).show();a.reposition(b);if(a.config.sectionAreaClass)a.$suggestionContainer.find("."+a.config.sectionAreaClass).on("mousedown",function(b){a.cancelBlur=!0;a.$suggestionContainer.delay(function(){delete a.cancelBlur})});a.hookSuggestions()}else a.$suggestionContainer.hide();else a.$suggestionContainer.hide()},handleKeyDown:function(a){var b=this;clearTimeout(b.timer);if(b.ENTER==a.keyCode)return b.$suggestionContainer.hide(),
b.config.submitFctn("search",b.$input.val(),b.$input),a.preventDefault(),!1;if(b.ARROW_UP==a.keyCode||b.ARROW_DOWN==a.keyCode)return b.arrowKey(a);b.timer=setTimeout(function(){var a=b.$input.val();if(a&&a.length>=b.config.minLength)g.when(b.suggest(a)).done(function(a){b.setCurrentSuggests(a);a.suggests&&a.suggests.length?b.getResults(0):b.$suggestionContainer.hide()});else if(b.config.userSuggestions)if((a=b.getUserSuggestions(a,b.config.userSuggestions.size||5))&&a.length){var a={offset:-1,suggests:a},
d=b.compiled({sug:a});b.setCurrentSuggests(a);b.$suggestionContainer.html(d).show();b.reposition(a)}else b.$suggestionContainer.hide();else b.$suggestionContainer.hide()},b.config.delay)},suggest:function(a){var b=g.Deferred();g.ajax({url:this.config.server+this.config.url,dataType:"jsonp",data:{dct:this.config.dict,num:this.config.search.size,key:this.$input.val(),sort:this.config.sort,reduce:this.config.reduce,match:this.config.matchAllSearchWords,anchor:this.config.matchAnySuggestionWord,site:this.config.currentSite},
success:function(a){var d={};d.input=a.input;if(a.suggests&&a.suggests.length){d.suggests=[];for(var e=0;e<a.suggests.length;e++){var f=a.suggests[e];d.suggests.push({sug:f.val,lhs:f.val.substring(0,f.start),hit:f.val.substring(f.start,f.end),rhs:f.val.substring(f.end)})}}b.resolve(d)}});return b.promise()},search:function(a){var b=this,c=g.Deferred();g.ajax({url:b.config.serverSearch+b.config.urlSearch+"?"+b.config.defaultSearchParams+"&customer=easayt",dataType:"jsonp",data:{dct:this.config.dict,
q:a,ResultsPerPage:b.config.products.size},success:function(a){c.resolve(a)},failure:function(a){b.pendingProds=!1;b.prods=null;b.addSearch(s)}});return c.promise()},getUserSuggestions:function(a,b){var c=h&&h.getAll()||[],d=[];if(a)for(var e=0;e<c.length&&d.length<b;e++)0==c[e].toLowerCase().indexOf(a)&&d.push({hit:c[e].substring(0,a.length),rhs:c[e].substring(a.length),sug:c[e]});for(e=0;e<c.length&&d.length<b;e++){for(var f=!1,g=0;g<d.length;g++)if(c[e]==d[g].sug){f=!0;break}f||d.push({sug:c[e],
rhs:c[e]})}return d},addUserSuggestion:function(a){a&&h&&h.add(a)},clearUserSuggestions:function(){h&&h.clear()}};k.defaults=k.prototype.defaults;g.fn.eaAutoComplete=function(a){return this.each(function(b){b=g(this).data("ea_sayt");b||(b=(new k(this,a)).init(),g(this).data("ea_sayt",b))})};return k});
